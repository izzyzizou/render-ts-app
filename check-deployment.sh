#!/bin/bash

# Deployment Check Script
# Run this locally to verify your setup before deploying to Render

echo "üîç Checking deployment readiness..."
echo ""

# Check if node_modules exists
if [ ! -d "node_modules" ]; then
  echo "‚ùå node_modules not found. Run: npm install"
  exit 1
else
  echo "‚úÖ node_modules exists"
fi

# Check if TypeScript compiles
echo "üî® Testing TypeScript compilation..."
if npm run build > /dev/null 2>&1; then
  echo "‚úÖ TypeScript compilation successful"
else
  echo "‚ùå TypeScript compilation failed. Check errors above."
  exit 1
fi

# Check if dist/index.js exists
if [ -f "dist/index.js" ]; then
  echo "‚úÖ dist/index.js exists"
else
  echo "‚ùå dist/index.js not found after build"
  exit 1
fi

# Check required files
echo "üìÅ Checking required files..."
files=("package.json" "tsconfig.json" "render.yaml" "schema.sql" "src/index.ts")
for file in "${files[@]}"; do
  if [ -f "$file" ]; then
    echo "‚úÖ $file exists"
  else
    echo "‚ùå $file is missing"
    exit 1
  fi
done

# Check environment variables (warn only)
echo ""
echo "‚ö†Ô∏è  Environment variables check (set these in Render):"
if [ -z "$DATABASE_URL" ]; then
  echo "   ‚ö†Ô∏è  DATABASE_URL not set (will be auto-set by Render)"
else
  echo "   ‚úÖ DATABASE_URL is set"
fi

if [ -z "$JWT_SECRET" ]; then
  echo "   ‚ö†Ô∏è  JWT_SECRET not set (will be auto-generated by Render)"
else
  echo "   ‚úÖ JWT_SECRET is set"
fi

if [ -z "$PORT" ]; then
  echo "   ‚ö†Ô∏è  PORT not set (defaults to 3000, Render will set to 10000)"
else
  echo "   ‚úÖ PORT is set to $PORT"
fi

# Check package.json scripts
echo ""
echo "üìú Checking package.json scripts..."
if grep -q '"start"' package.json; then
  echo "‚úÖ start script found"
else
  echo "‚ùå start script missing in package.json"
  exit 1
fi

if grep -q '"build"' package.json; then
  echo "‚úÖ build script found"
else
  echo "‚ùå build script missing in package.json"
  exit 1
fi

# Test start command (dry run)
echo ""
echo "üöÄ Testing start command (syntax check only)..."
if node --check dist/index.js > /dev/null 2>&1; then
  echo "‚úÖ dist/index.js syntax is valid"
else
  echo "‚ùå dist/index.js has syntax errors"
  exit 1
fi

echo ""
echo "‚ú® All checks passed! Your project is ready for Render deployment."
echo ""
echo "Next steps:"
echo "1. Push your code to GitHub"
echo "2. Go to Render Dashboard ‚Üí New ‚Üí Blueprint"
echo "3. Connect your repository"
echo "4. Apply the blueprint"
echo "5. Initialize database schema after database is created"
echo ""
echo "For detailed instructions, see RENDER_DEPLOYMENT.md"
